<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/style.css">
    <title>Simulador de palpite</title>

</head>

<body>

    <div class="app">

        <h1 class="title">Simulador de palpite</h1>

        <div class="palpite">
            <h2 class="title">Meu palpite <span id="numeros-palpite"></span></h2>
            <div class="numeros"></div>
            <span class="bloquear-display"></span>
        </div>

        <div class="globo">
            <h2 class="title">Globo</h2>
            <div class="bolas" id="bolas">
                <div class="numeros"></div>
            </div>
        </div>

        <button class="btn-consultar">Consultar</button>

    </div>

    <script>

        const bolas = document.querySelector("#bolas > .numeros");
        const palpite = document.querySelector("div.palpite > .numeros");
        const numerosPalpiteView = document.getElementById("numeros-palpite");
        const btnConsultar = document.querySelector("button.btn-consultar");
        let numerosPalpite = [];
        
        btnConsultar.addEventListener("click",()=>{ apiResultadosMega(btnConsultar) },false);

        // cria uma nova instância de observador
        var observer = new MutationObserver(function (mutations) {

            validarPalpite(mutations[0].target);

        });

        // configuração do observador:
        var config = { attributes: true, childList: true, characterData: true };

        observer.observe(palpite, config);

        // Criando as bolas no globo
        for (let i = 1; i <= 60; ++i) {
            const numStr = i.toString().padStart(2, '0');

            const bola = document.createElement("div");
            bola.id = `bola_${numStr}`;
            bola.innerText = numStr;
            bola.title = numStr;
            bola.className = "bola";
            bola.addEventListener("click", () => { selBolaPalpite(bola); bola.style.display = "none" });
            bolas.appendChild(bola);
        }

        // Adicionando bola ao palpite
        function selBolaPalpite(element) {
            const num = Number(element.title);
            const bolaPalpite = element.cloneNode(true);

            bolaPalpite.addEventListener("click", () => { remBolaPalpite(bolaPalpite) });

            palpite.appendChild(bolaPalpite);

            numerosPalpite.push(num);

            numerosPalpiteView.innerHTML = " > " + numerosPalpite.toString();
        }

        // Removendo bola do palpite
        function remBolaPalpite(element) {
            const bolaGlobo = document.querySelector(`div.globo > div#bolas div#${element.id}`);
            element.remove();

            bolaGlobo.style.display = "flex";

            numerosPalpite = numerosPalpite.filter((item) => item !== Number(bolaGlobo.title));

            numerosPalpiteView.innerHTML = " > " + numerosPalpite.toString();
        }

        // Observando numeros adicionados
        function validarPalpite(target) {

            const qntNum = target.querySelectorAll("div").length;

            if (qntNum === 6) {
                btnConsultar.style.display = "block";
            } else {
                btnConsultar.style.display = "none";
            }
        }

        // API Consultar resultados
        function apiResultadosMega(button_action) {
            
            const blockPalpite = document.querySelector("span.bloquear-display");

            var myHeaders = new Headers();
            myHeaders.append("Content-Type", "application/json");

            var raw = JSON.stringify( numerosPalpite );

            var requestOptions = {
                method: 'POST',
                headers: myHeaders,
                body: raw,
                redirect: 'follow'
            };

            fetch("https://meupalpite.vercel.app/palpite", requestOptions)
                .then(response => response.json())
                .then(result => {
                    const resultJson = JSON.stringify(result);
                    localStorage.resultado_api = resultJson;
                    setTimeout(renderResult,500);
                })
                .catch(error => console.log('error', error));
        
            
            button_action.style.display = "none";
            bolas.parentElement.style.display = "none";
            bolas.parentElement.parentElement.querySelector(".title").innerText = "Aguarde...";
            blockPalpite.style.display = "block";
        }

        function renderResult() {

            bolas.parentElement.parentElement.querySelector(".title").innerText = "Resultado";

            const jsonObject = JSON.parse(localStorage.resultado_api);
            const jsonObjectNumAcertos=[];
            const listNumAcerto = [];

            jsonObject.forEach((item)=>{
                const numAcertos = item.qnt_acerto;

                if ( !listNumAcerto.includes(numAcertos) ) {
                    listNumAcerto.push(numAcertos);
                }
                
            });

            listNumAcerto.sort(function(a,b) { return b - a });

            listNumAcerto.forEach((item)=>{
                let totalJogos = 0;
                let listItem = [];

                jsonObject.map(i => {
                    if ( i.qnt_acerto === item ) {
                        ++totalJogos;
                        listItem.push(i);
                    }
                });

                jsonObjectNumAcertos.push({
                    num_acertos:item,
                    total_jogos:totalJogos,
                    lista_resultados:listItem
                });
            });

            localStorage.resultado_api_detalhes = JSON.stringify(jsonObjectNumAcertos);

            criarListaResultado();
        }

        function criarListaResultado() {
            const resultado_api_detalhes = JSON.parse(localStorage.resultado_api_detalhes);

            const listResultados = document.createElement("div");
            listResultados.className = "lista-resultados";
            listResultados.id = "lista-resultados";

            const texto = document.createElement("span");
            texto.className = "texto-resultado";
            texto.innerText = "Veja os dados historicos da Mega-Sena em relação ao seu palpite!";

            const lista = document.createElement("div");
            lista.className = "lista";

            resultado_api_detalhes.forEach(resultado=>{
                const item = addItemResultado(resultado);
                lista.appendChild(item);
            });

            listResultados.appendChild(texto);
            listResultados.appendChild(lista);
            bolas.parentElement.parentElement.appendChild(listResultados);
        }

        function addItemResultado(i) {
            const item = document.createElement("div");
            item.className="lista-item";
            item.id = i.num_acertos;

            const itemTextTop = document.createElement("span");
            itemTextTop.className="item-text-top";
            itemTextTop.innerHTML=`<strong>Quantidade de numeros acerto</strong><span>${i.num_acertos}</span>`

            const itemTextBottom = document.createElement("span");
            itemTextBottom.className="item-text-botton";
            itemTextBottom.innerText=`Foram encontrados ${i.total_jogos} jogos em que houve acerto de ${i.num_acertos} numeros do palpite.`
            
            item.appendChild(itemTextTop);
            item.appendChild(itemTextBottom);

            item.addEventListener("click",()=>{ listaJogosPorQntAcerto(i.num_acertos,item) });

            return item;
        }

        function listaJogosPorQntAcerto(num_acertos,element) {
            const resultado_api_detalhes = JSON.parse(localStorage.resultado_api_detalhes);
            let result;

            
            resultado_api_detalhes.map(i => {
                if ( i.num_acertos === num_acertos ) {
                    result = i;
                }
            });

            const globo = element.parentElement.parentElement.parentElement;

            const popup = document.createElement("div");
            popup.className="popup";

            const conteudo = document.createElement("div");
            conteudo.className="popup-conteudo";

            const btnClose = document.createElement("button");
            btnClose.className = "popup-btn-fechar";
            btnClose.innerText = "X";
            btnClose.setAttribute("onclick","fecharPopUp(this)")

            popup.appendChild(conteudo);            

            const lista = document.createElement("div");
            lista.className="popup-lista";

            const title = document.createElement("div");
            title.className="popup-title";
            title.innerText=`Quantidade de acertos ${result.num_acertos}, Total de jogos ${result.total_jogos}`;

            conteudo.appendChild(btnClose);
            conteudo.appendChild(title);
            conteudo.appendChild(lista);

            // adicionando itens a lista
            result.lista_resultados.forEach((jogo)=>{

                const itemLista = document.createElement("div");
                itemLista.className="popup-lista-item";

                const itemListaTop = document.createElement("span");
                itemListaTop.className = "popup-lista-item-top";
                itemListaTop.innerHTML=`
                <span>${jogo['Data do Sorteio']}</span><span>${jogo['Concurso']}</<span>
                `
                
                const itemListaBotton = document.createElement("span");
                itemListaBotton.className = "popup-lista-item-botton";
                itemListaBotton.innerHTML = `
                    <span>${jogo['Bola1']}</span>
                    <span>${jogo['Bola2']}</span>
                    <span>${jogo['Bola3']}</span>
                    <span>${jogo['Bola4']}</span>
                    <span>${jogo['Bola5']}</span>
                    <span>${jogo['Bola6']}</span>
                `

                itemLista.appendChild(itemListaTop)
                itemLista.appendChild(itemListaBotton);

                lista.appendChild(itemLista);
            });
            
            globo.appendChild(popup);
            setTimeout(realceBolaAcerto,1000);
        }

        function fecharPopUp(btn_element) {
            btn_element.parentElement.parentElement.remove();
        }

        function realceBolaAcerto() { 
            const lista = document.querySelector("div.popup-lista");
            const rows = lista.querySelectorAll(".popup-lista-item");

            rows.forEach((row)=>{
                const bolas = row.querySelectorAll(".popup-lista-item-botton > span");

                bolas.forEach((bola)=>{
                    let n = Number(bola.innerText);

                    if (numerosPalpite.includes(n)) {
                        bola.className="focus";
                    }
                })

            });
        }

    </script>

</body>

</html>